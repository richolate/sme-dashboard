{% extends 'base.html' %}
{% load dashboard_filters %}

{% block title %}{{ page_title }} - Dashboard Performance Highlights SME{% endblock %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block content %}

{% if no_data %}
<div class="alert alert-warning" role="alert">
    <h5 class="alert-heading"><i class="bi bi-exclamation-triangle"></i> Tidak Ada Data</h5>
    <p>Belum ada data yang tersedia di database. Silakan upload data terlebih dahulu melalui menu <a href="{% url 'data_management:upload_data' %}" class="alert-link">Upload Data</a>.</p>
    <hr>
    <p class="mb-0">Setelah data berhasil di-upload, halaman ini akan menampilkan tabel dan grafik yang sesuai.</p>
</div>
{% else %}

{% if show_chart %}
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Grafik Timeseries</h6>
            
            <!-- Filter Form -->
            <form method="get" class="d-flex gap-2 align-items-center">
                            
                <!-- Segment Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="segmentDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Segment
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="segmentDropdown" style="min-width: 200px;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="segment" value="ALL" id="seg_all" 
                                    {% if 'ALL' in filters.selected_segments %}checked{% endif %}>
                                <label class="form-check-label" for="seg_all">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for seg in filters.segments %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="segment" value="{{ seg }}" id="seg_{{ seg }}"
                                        {% if seg in filters.selected_segments %}checked{% endif %}>
                                    <label class="form-check-label" for="seg_{{ seg }}">{{ seg }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Kanca Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="kancaDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Kanca
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="kancaDropdown" style="min-width: 250px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="kanca" value="ALL" id="kanca_all"
                                    {% if 'ALL' in filters.selected_kancas %}checked{% endif %}>
                                <label class="form-check-label" for="kanca_all">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for k in filters.kancas %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="kanca" value="{{ k }}" id="kanca_{{ forloop.counter }}"
                                        {% if k in filters.selected_kancas %}checked{% endif %}>
                                    <label class="form-check-label" for="kanca_{{ forloop.counter }}">{{ k }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </form>

            <!-- SCRIPT SELECT ALL + AUTO SUBMIT -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
                const form = document.querySelector('#segmentDropdown').closest('form');

                function setupSelectAll(selectAllId, selector) {
                    const selectAll = document.getElementById(selectAllId);
                    const items = document.querySelectorAll(selector);

                    // Ketika Select All dicentang
                    selectAll.addEventListener("change", function () {
                        if (this.checked) {
                            items.forEach(i => {
                                if (i !== selectAll) i.checked = false;
                            });
                        }
                        form.submit(); // Auto submit
                    });

                    // Ketika item lain dicentang
                    items.forEach(i => {
                        if (i !== selectAll) {
                            i.addEventListener("change", function () {
                                if (this.checked) {
                                    selectAll.checked = false;
                                }
                                form.submit(); // Auto submit
                            });
                        }
                    });
                }

                setupSelectAll("seg_all", "input[name='segment']");
                setupSelectAll("kanca_all", "input[name='kanca']");
            });
            </script>

        </div>
    </div>
    <div class="card-body">
        <!-- Container dengan tinggi minimum agar chart tidak terlalu kecil -->
        <div style="min-height: 500px; height: 60vh;">
            <canvas id="metricChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('metricChart').getContext('2d');
        const chartData = JSON.parse('{{ chart_data_json|escapejs }}');
        
        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                // Format as Billions/Trillions for readability
                                if (value >= 1000000000000) {
                                    return (value / 1000000000000).toFixed(1) + 'T';
                                } else if (value >= 1000000000) {
                                    return (value / 1000000000).toFixed(1) + 'M';
                                }
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    });
</script>
{% endif %}

{% comment %}
================================================================================
SECTION: Stacked Bar Chart for Timeseries OS DPK NPL LAR
================================================================================
{% endcomment %}
{% if show_stacked_chart %}
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Grafik Timeseries OS, DPK, NPL, LAR</h6>
            
            <!-- Filter Form -->
            <form method="get" class="d-flex gap-2 align-items-center">
                            
                <!-- Segment Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="segmentDropdownStacked" data-bs-toggle="dropdown" aria-expanded="false">
                        Segment
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="segmentDropdownStacked" style="min-width: 200px;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="segment" value="ALL" id="seg_all_stacked" 
                                    {% if 'ALL' in filters.selected_segments %}checked{% endif %}>
                                <label class="form-check-label" for="seg_all_stacked">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for seg in filters.segments %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="segment" value="{{ seg }}" id="seg_stacked_{{ seg }}"
                                        {% if seg in filters.selected_segments %}checked{% endif %}>
                                    <label class="form-check-label" for="seg_stacked_{{ seg }}">{{ seg }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Kanca Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="kancaDropdownStacked" data-bs-toggle="dropdown" aria-expanded="false">
                        Kanca
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="kancaDropdownStacked" style="min-width: 250px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="kanca" value="ALL" id="kanca_all_stacked"
                                    {% if 'ALL' in filters.selected_kancas %}checked{% endif %}>
                                <label class="form-check-label" for="kanca_all_stacked">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for k in filters.kancas %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="kanca" value="{{ k }}" id="kanca_stacked_{{ forloop.counter }}"
                                        {% if k in filters.selected_kancas %}checked{% endif %}>
                                    <label class="form-check-label" for="kanca_stacked_{{ forloop.counter }}">{{ k }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </form>

            <!-- SCRIPT SELECT ALL + AUTO SUBMIT for Stacked Chart -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
                const formStacked = document.querySelector('#segmentDropdownStacked').closest('form');

                function setupSelectAllStacked(selectAllId, selector) {
                    const selectAll = document.getElementById(selectAllId);
                    const items = document.querySelectorAll(selector);

                    // Ketika Select All dicentang
                    selectAll.addEventListener("change", function () {
                        if (this.checked) {
                            items.forEach(i => {
                                if (i !== selectAll) i.checked = false;
                            });
                        }
                        formStacked.submit(); // Auto submit
                    });

                    // Ketika item lain dicentang
                    items.forEach(i => {
                        if (i !== selectAll) {
                            i.addEventListener("change", function () {
                                if (this.checked) {
                                    selectAll.checked = false;
                                }
                                formStacked.submit(); // Auto submit
                            });
                        }
                    });
                }

                setupSelectAllStacked("seg_all_stacked", "input[name='segment']");
                setupSelectAllStacked("kanca_all_stacked", "input[name='kanca']");
            });
            </script>

        </div>
    </div>
    <div class="card-body">
        <!-- Container dengan tinggi minimum agar chart tidak terlalu kecil -->
        <div style="min-height: 500px; height: 60vh;">
            <canvas id="stackedMetricChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('stackedMetricChart').getContext('2d');
        const chartData = JSON.parse('{{ chart_data_json|escapejs }}');
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        new Chart(ctx, {
            type: 'bar',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        stacked: true,
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    },
                    y: {
                        stacked: true,
                        beginAtZero: true,
                        ticks: {
                            callback: function(value, index, values) {
                                // Format as Millions (M) or Trillions (T) for readability
                                if (value >= 1000000000000) {
                                    return (value / 1000000000000).toFixed(1) + 'T';
                                } else if (value >= 1000000000) {
                                    return (value / 1000000000).toFixed(1) + 'M';
                                }
                                return value;
                            }
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Only show label on the last (top) dataset for stacked total
                            return context.datasetIndex === context.chart.data.datasets.length - 1;
                        },
                        anchor: 'end',
                        align: 'top',
                        formatter: function(value, context) {
                            // Calculate total of all stacked values for this bar
                            let total = 0;
                            context.chart.data.datasets.forEach(function(dataset) {
                                total += dataset.data[context.dataIndex] || 0;
                            });
                            // Format as M (Millions)
                            if (total >= 1000000000000) {
                                return (total / 1000000000000).toFixed(2) + 'T';
                            } else if (total >= 1000000000) {
                                return (total / 1000000000).toFixed(2) + 'M';
                            }
                            return total.toLocaleString('id-ID');
                        },
                        color: '#333',
                        font: {
                            weight: 'bold',
                            size: 10
                        }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% comment %}
================================================================================
END SECTION: Stacked Bar Chart
================================================================================
{% endcomment %}

{% comment %}
================================================================================
SECTION: Daily Line/Area Chart for Timeseries Baki Debit UKER
================================================================================
{% endcomment %}
{% if show_daily_chart %}
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Time Series Harian Baki Debit</h6>
            
            <!-- Filter Form -->
            <form method="get" class="d-flex gap-2 align-items-center flex-wrap">
                
                <!-- Year Filter (Radio Buttons) -->
                <div class="btn-group" role="group" aria-label="Year filter">
                    {% for yr in filters.years %}
                        <input type="radio" class="btn-check" name="year" value="{{ yr }}" id="year_{{ yr }}" 
                            {% if filters.selected_year == yr|stringformat:"s" %}checked{% endif %} autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="year_{{ yr }}">{{ yr }}</label>
                    {% endfor %}
                </div>
                
                <!-- Month Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="monthDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Bulan
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="monthDropdown" style="min-width: 200px; max-height: 300px; overflow-y: auto;">
                        {% for m in filters.months %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="month" value="{{ m.value }}" id="month_{{ m.value }}"
                                        {% if m.value|stringformat:"s" in filters.selected_months %}checked{% endif %}>
                                    <label class="form-check-label" for="month_{{ m.value }}">{{ m.name }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Segment Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="segmentDropdownDaily" data-bs-toggle="dropdown" aria-expanded="false">
                        Segment
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="segmentDropdownDaily" style="min-width: 200px;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="segment" value="ALL" id="seg_all_daily" 
                                    {% if 'ALL' in filters.selected_segments %}checked{% endif %}>
                                <label class="form-check-label" for="seg_all_daily">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for seg in filters.segments %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="segment" value="{{ seg }}" id="seg_daily_{{ seg }}"
                                        {% if seg in filters.selected_segments %}checked{% endif %}>
                                    <label class="form-check-label" for="seg_daily_{{ seg }}">{{ seg }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Kanca Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="kancaDropdownDaily" data-bs-toggle="dropdown" aria-expanded="false">
                        Kanca
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="kancaDropdownDaily" style="min-width: 250px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="kanca" value="ALL" id="kanca_all_daily"
                                    {% if 'ALL' in filters.selected_kancas %}checked{% endif %}>
                                <label class="form-check-label" for="kanca_all_daily">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for k in filters.kancas %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="kanca" value="{{ k }}" id="kanca_daily_{{ forloop.counter }}"
                                        {% if k in filters.selected_kancas %}checked{% endif %}>
                                    <label class="form-check-label" for="kanca_daily_{{ forloop.counter }}">{{ k }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </form>

            <!-- SCRIPT SELECT ALL + AUTO SUBMIT for Daily Chart -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
                const formDaily = document.querySelector('#segmentDropdownDaily').closest('form');

                // Auto submit when year radio button changes
                document.querySelectorAll('input[name="year"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        formDaily.submit();
                    });
                });

                // Auto submit when month checkbox changes
                document.querySelectorAll('input[name="month"]').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        formDaily.submit();
                    });
                });

                function setupSelectAllDaily(selectAllId, selector) {
                    const selectAll = document.getElementById(selectAllId);
                    if (!selectAll) return;
                    
                    const items = document.querySelectorAll(selector);

                    selectAll.addEventListener("change", function () {
                        if (this.checked) {
                            items.forEach(i => {
                                if (i !== selectAll) i.checked = false;
                            });
                        }
                        formDaily.submit(); // Auto submit
                    });

                    items.forEach(i => {
                        if (i !== selectAll) {
                            i.addEventListener("change", function () {
                                if (this.checked) {
                                    selectAll.checked = false;
                                }
                                formDaily.submit(); // Auto submit
                            });
                        }
                    });
                }

                setupSelectAllDaily("seg_all_daily", "input[name='segment']");
                setupSelectAllDaily("kanca_all_daily", "input[name='kanca']");
            });
            </script>

        </div>
    </div>
    <div class="card-body">
        <!-- Container dengan tinggi minimum agar chart tidak terlalu kecil -->
        <div style="min-height: 500px; height: 60vh;">
            <canvas id="dailyMetricChart"></canvas>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('dailyMetricChart').getContext('2d');
        const chartData = JSON.parse('{{ chart_data_json|escapejs }}');
        
        // Register the datalabels plugin
        Chart.register(ChartDataLabels);
        
        new Chart(ctx, {
            type: 'line',
            data: chartData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tanggal',
                            font: { weight: 'bold' }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Baki Debet (OS)',
                            font: { weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value, index, values) {
                                // Format as Millions (M) or Trillions (T) for readability
                                if (value >= 1000000000000) {
                                    return (value / 1000000000000).toFixed(2) + 'T';
                                } else if (value >= 1000000000) {
                                    return (value / 1000000000).toFixed(2) + 'M';
                                }
                                return value;
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return 'Tanggal ' + context[0].label;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Show labels only at specific points (every 5 days or at peaks)
                            const index = context.dataIndex;
                            return index % 1 === 0 || index === context.dataset.data.length - 1;
                        },
                        anchor: 'end',
                        align: 'top',
                        offset: 5,
                        formatter: function(value, context) {
                            if (value === null) return '';
                            // Format as M (Millions)
                            if (value >= 1000000000000) {
                                return (value / 1000000000000).toFixed(2) + 'T';
                            } else if (value >= 1000000000) {
                                return (value / 1000000000).toFixed(2) + 'M';
                            }
                            return value.toLocaleString('id-ID');
                        },
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: {
                            weight: 'bold',
                            size: 9
                        }
                    }
                }
            }
        });
    });
</script>
{% endif %}
{% comment %}
================================================================================
END SECTION: Daily Line/Area Chart
================================================================================
{% endcomment %}

{% comment %}
================================================================================
SECTION: Monthly 4 Charts for Timeseries Bulanan (SML, NPL, OS, LAR)
================================================================================
{% endcomment %}
{% if show_monthly_charts %}
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Time Series Bulanan</h6>
            
            <!-- Filter Form -->
            <form method="get" class="d-flex gap-2 align-items-center flex-wrap" id="monthlyFilterForm">
                
                <!-- Year Filter (Dropdown Checkbox - Multiple Selection) -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" id="yearDropdownMonthly" data-bs-toggle="dropdown" aria-expanded="false">
                        Year
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="yearDropdownMonthly" style="min-width: 150px;">
                        {% for yr in filters.years %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input monthly-year-check" type="checkbox" name="year" value="{{ yr }}" id="year_monthly_{{ yr }}"
                                        {% if yr|stringformat:"s" in filters.selected_years %}checked{% endif %}>
                                    <label class="form-check-label" for="year_monthly_{{ yr }}">{{ yr }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Month Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="monthDropdownMonthly" data-bs-toggle="dropdown" aria-expanded="false">
                        Bulan
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="monthDropdownMonthly" style="min-width: 200px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="month_all_monthly" 
                                    {% if filters.selected_months|length == 12 %}checked{% endif %}>
                                <label class="form-check-label" for="month_all_monthly"><strong>Select All</strong></label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for m in filters.months %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input monthly-month-check" type="checkbox" name="month" value="{{ m.value }}" id="month_monthly_{{ m.value }}"
                                        {% if m.value|stringformat:"s" in filters.selected_months %}checked{% endif %}>
                                    <label class="form-check-label" for="month_monthly_{{ m.value }}">{{ m.name }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Segment Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="segmentDropdownMonthly" data-bs-toggle="dropdown" aria-expanded="false">
                        Segment
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="segmentDropdownMonthly" style="min-width: 200px;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="segment" value="ALL" id="seg_all_monthly" 
                                    {% if 'ALL' in filters.selected_segments %}checked{% endif %}>
                                <label class="form-check-label" for="seg_all_monthly">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for seg in filters.segments %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input monthly-seg-check" type="checkbox" name="segment" value="{{ seg }}" id="seg_monthly_{{ seg }}"
                                        {% if seg in filters.selected_segments %}checked{% endif %}>
                                    <label class="form-check-label" for="seg_monthly_{{ seg }}">{{ seg }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Kanca Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="kancaDropdownMonthly" data-bs-toggle="dropdown" aria-expanded="false">
                        Kanca
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="kancaDropdownMonthly" style="min-width: 250px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="kanca" value="ALL" id="kanca_all_monthly"
                                    {% if 'ALL' in filters.selected_kancas %}checked{% endif %}>
                                <label class="form-check-label" for="kanca_all_monthly">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for k in filters.kancas %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input monthly-kanca-check" type="checkbox" name="kanca" value="{{ k }}" id="kanca_monthly_{{ forloop.counter }}"
                                        {% if k in filters.selected_kancas %}checked{% endif %}>
                                    <label class="form-check-label" for="kanca_monthly_{{ forloop.counter }}">{{ k }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </form>

            <!-- SCRIPT AUTO SUBMIT for Monthly Charts -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
                const formMonthly = document.getElementById('monthlyFilterForm');

                // Auto submit when any year checkbox changes
                document.querySelectorAll('.monthly-year-check').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        formMonthly.submit();
                    });
                });

                // Auto submit when any month checkbox changes
                document.querySelectorAll('.monthly-month-check').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        formMonthly.submit();
                    });
                });

                // Select All months logic
                const monthAllCheckbox = document.getElementById('month_all_monthly');
                const monthCheckboxes = document.querySelectorAll('.monthly-month-check');
                
                monthAllCheckbox.addEventListener('change', function() {
                    monthCheckboxes.forEach(cb => cb.checked = this.checked);
                    formMonthly.submit();
                });

                // Segment Select All logic
                const segAllMonthly = document.getElementById('seg_all_monthly');
                const segCheckboxes = document.querySelectorAll('.monthly-seg-check');
                
                segAllMonthly.addEventListener('change', function() {
                    if (this.checked) {
                        segCheckboxes.forEach(cb => cb.checked = false);
                    }
                    formMonthly.submit();
                });

                segCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            segAllMonthly.checked = false;
                        }
                        formMonthly.submit();
                    });
                });

                // Kanca Select All logic
                const kancaAllMonthly = document.getElementById('kanca_all_monthly');
                const kancaCheckboxes = document.querySelectorAll('.monthly-kanca-check');
                
                kancaAllMonthly.addEventListener('change', function() {
                    if (this.checked) {
                        kancaCheckboxes.forEach(cb => cb.checked = false);
                    }
                    formMonthly.submit();
                });

                kancaCheckboxes.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            kancaAllMonthly.checked = false;
                        }
                        formMonthly.submit();
                    });
                });
            });
            </script>

        </div>
    </div>
    <div class="card-body">
        <!-- 4 Charts in 2x2 Grid -->
        <div class="row">
            <!-- Chart 1: SML -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong>Time Series Bulanan SML</strong>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="chartSML"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart 2: NPL -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong>Time Series Bulanan NPL</strong>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="chartNPL"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart 3: Baki Debet (OS) -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong>Time Series Bulanan Baki Debet</strong>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="chartOS"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Chart 4: LAR -->
            <div class="col-md-6 mb-4">
                <div class="card h-100">
                    <div class="card-header bg-light">
                        <strong>Time Series Bulanan LAR</strong>
                    </div>
                    <div class="card-body">
                        <div style="height: 350px;">
                            <canvas id="chartLAR"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Register datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Chart data from Django
        const chartSMLData = JSON.parse('{{ chart_sml_json|escapejs }}');
        const chartNPLData = JSON.parse('{{ chart_npl_json|escapejs }}');
        const chartOSData = JSON.parse('{{ chart_os_json|escapejs }}');
        const chartLARData = JSON.parse('{{ chart_lar_json|escapejs }}');
        
        // Common chart options for smoothed line chart
        function getChartOptions(title) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            display: false
                        }
                    },
                    y: {
                        beginAtZero: false,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000000000) {
                                    return (value / 1000000000000).toFixed(2) + 'T';
                                } else if (value >= 1000000000) {
                                    return (value / 1000000000).toFixed(3) + 'M';
                                }
                                return value;
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Show label at every point
                            return true;
                        },
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        formatter: function(value) {
                            if (value === null) return '';
                            if (value >= 1000000000000) {
                                return (value / 1000000000000).toFixed(3) + 'T';
                            } else if (value >= 1000000000) {
                                return (value / 1000000000).toFixed(3) + 'M';
                            }
                            return value.toLocaleString('id-ID');
                        },
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: {
                            weight: 'bold',
                            size: 8
                        }
                    }
                }
            };
        }
        
        // Chart 1: SML
        new Chart(document.getElementById('chartSML').getContext('2d'), {
            type: 'line',
            data: chartSMLData,
            options: getChartOptions('SML')
        });
        
        // Chart 2: NPL
        new Chart(document.getElementById('chartNPL').getContext('2d'), {
            type: 'line',
            data: chartNPLData,
            options: getChartOptions('NPL')
        });
        
        // Chart 3: OS
        new Chart(document.getElementById('chartOS').getContext('2d'), {
            type: 'line',
            data: chartOSData,
            options: getChartOptions('Baki Debet')
        });
        
        // Chart 4: LAR
        new Chart(document.getElementById('chartLAR').getContext('2d'), {
            type: 'line',
            data: chartLARData,
            options: getChartOptions('LAR')
        });
    });
</script>
{% endif %}
{% comment %}
================================================================================
END SECTION: Monthly 4 Charts
================================================================================
{% endcomment %}

{% comment %}
================================================================================
SECTION: Daily 3 Charts for Timeseries Harian (LAR, NPL, SML - Stacked Vertically)
================================================================================
{% endcomment %}
{% if show_daily_three_charts %}
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0">Time Series Harian</h6>
            
            <!-- Filter Form -->
            <form method="get" class="d-flex gap-2 align-items-center flex-wrap" id="dailyThreeFilterForm">
                
                <!-- Year Filter (Radio Buttons) -->
                <div class="btn-group" role="group" aria-label="Year filter">
                    {% for yr in filters.years %}
                        <input type="radio" class="btn-check" name="year" value="{{ yr }}" id="year_dt_{{ yr }}" 
                            {% if filters.selected_year == yr|stringformat:"s" %}checked{% endif %} autocomplete="off">
                        <label class="btn btn-outline-primary btn-sm" for="year_dt_{{ yr }}">{{ yr }}</label>
                    {% endfor %}
                </div>
                
                <!-- Month Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="monthDropdownDT" data-bs-toggle="dropdown" aria-expanded="false">
                        Bulan
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="monthDropdownDT" style="min-width: 200px; max-height: 300px; overflow-y: auto;">
                        {% for m in filters.months %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input dt-month-check" type="checkbox" name="month" value="{{ m.value }}" id="month_dt_{{ m.value }}"
                                        {% if m.value|stringformat:"s" in filters.selected_months %}checked{% endif %}>
                                    <label class="form-check-label" for="month_dt_{{ m.value }}">{{ m.name }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
                
                <!-- Segment Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="segmentDropdownDT" data-bs-toggle="dropdown" aria-expanded="false">
                        Segment
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="segmentDropdownDT" style="min-width: 200px;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="segment" value="ALL" id="seg_all_dt" 
                                    {% if 'ALL' in filters.selected_segments %}checked{% endif %}>
                                <label class="form-check-label" for="seg_all_dt">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for seg in filters.segments %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input dt-seg-check" type="checkbox" name="segment" value="{{ seg }}" id="seg_dt_{{ seg }}"
                                        {% if seg in filters.selected_segments %}checked{% endif %}>
                                    <label class="form-check-label" for="seg_dt_{{ seg }}">{{ seg }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Kanca Filter (Dropdown Checkbox) -->
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="kancaDropdownDT" data-bs-toggle="dropdown" aria-expanded="false">
                        Kanca
                    </button>
                    <ul class="dropdown-menu p-3" aria-labelledby="kancaDropdownDT" style="min-width: 250px; max-height: 300px; overflow-y: auto;">
                        <li>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="kanca" value="ALL" id="kanca_all_dt"
                                    {% if 'ALL' in filters.selected_kancas %}checked{% endif %}>
                                <label class="form-check-label" for="kanca_all_dt">Select All</label>
                            </div>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        {% for k in filters.kancas %}
                            <li>
                                <div class="form-check">
                                    <input class="form-check-input dt-kanca-check" type="checkbox" name="kanca" value="{{ k }}" id="kanca_dt_{{ forloop.counter }}"
                                        {% if k in filters.selected_kancas %}checked{% endif %}>
                                    <label class="form-check-label" for="kanca_dt_{{ forloop.counter }}">{{ k }}</label>
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                </div>

            </form>

            <!-- SCRIPT AUTO SUBMIT for Daily Three Charts -->
            <script>
            document.addEventListener("DOMContentLoaded", function () {
                const formDT = document.getElementById('dailyThreeFilterForm');

                // Auto submit when year radio button changes
                document.querySelectorAll('#dailyThreeFilterForm input[name="year"]').forEach(function(radio) {
                    radio.addEventListener('change', function() {
                        formDT.submit();
                    });
                });

                // Auto submit when month checkbox changes
                document.querySelectorAll('.dt-month-check').forEach(function(checkbox) {
                    checkbox.addEventListener('change', function() {
                        formDT.submit();
                    });
                });

                // Segment Select All logic
                const segAllDT = document.getElementById('seg_all_dt');
                const segCheckboxesDT = document.querySelectorAll('.dt-seg-check');
                
                segAllDT.addEventListener('change', function() {
                    if (this.checked) {
                        segCheckboxesDT.forEach(cb => cb.checked = false);
                    }
                    formDT.submit();
                });

                segCheckboxesDT.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            segAllDT.checked = false;
                        }
                        formDT.submit();
                    });
                });

                // Kanca Select All logic
                const kancaAllDT = document.getElementById('kanca_all_dt');
                const kancaCheckboxesDT = document.querySelectorAll('.dt-kanca-check');
                
                kancaAllDT.addEventListener('change', function() {
                    if (this.checked) {
                        kancaCheckboxesDT.forEach(cb => cb.checked = false);
                    }
                    formDT.submit();
                });

                kancaCheckboxesDT.forEach(cb => {
                    cb.addEventListener('change', function() {
                        if (this.checked) {
                            kancaAllDT.checked = false;
                        }
                        formDT.submit();
                    });
                });
            });
            </script>

        </div>
    </div>
    <div class="card-body">
        <!-- 3 Charts Stacked Vertically -->
        
        <!-- Chart 1: LAR -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong>Time Series Harian LAR</strong>
            </div>
            <div class="card-body">
                <div style="min-height: 400px; height: 45vh;">
                    <canvas id="chartDailyLAR"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Chart 2: NPL -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong>Time Series Harian NPL</strong>
            </div>
            <div class="card-body">
                <div style="min-height: 400px; height: 45vh;">
                    <canvas id="chartDailyNPL"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Chart 3: SML -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <strong>Time Series Harian SML</strong>
            </div>
            <div class="card-body">
                <div style="min-height: 400px; height: 45vh;">
                    <canvas id="chartDailySML"></canvas>
                </div>
            </div>
        </div>
        
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Register datalabels plugin
        Chart.register(ChartDataLabels);
        
        // Chart data from Django
        const chartLARData = JSON.parse('{{ chart_lar_json|escapejs }}');
        const chartNPLData = JSON.parse('{{ chart_npl_json|escapejs }}');
        const chartSMLData = JSON.parse('{{ chart_sml_json|escapejs }}');
        
        // Common chart options for smoothed line chart
        function getDailyChartOptions(title, yAxisTitle) {
            return {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Tanggal',
                            font: { weight: 'bold' }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: yAxisTitle,
                            font: { weight: 'bold' }
                        },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000000000) {
                                    return (value / 1000000000000).toFixed(2) + 'T';
                                } else if (value >= 1000000000) {
                                    return (value / 1000000000).toFixed(2) + 'M';
                                }
                                return value;
                            }
                        },
                        grid: {
                            display: true,
                            color: 'rgba(0, 0, 0, 0.05)'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            title: function(context) {
                                return 'Tanggal ' + context[0].label;
                            },
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(context.parsed.y);
                                }
                                return label;
                            }
                        }
                    },
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 10,
                            font: { size: 11 }
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Show label at every 5th point or at the last point
                            const index = context.dataIndex;
                            const dataLength = context.dataset.data.filter(d => d !== null).length;
                            return index % 5 === 0 || index === dataLength - 1;
                        },
                        anchor: 'end',
                        align: 'top',
                        offset: 2,
                        formatter: function(value) {
                            if (value === null) return '';
                            if (value >= 1000000000000) {
                                return (value / 1000000000000).toFixed(2) + 'T';
                            } else if (value >= 1000000000) {
                                return (value / 1000000000).toFixed(2) + 'M';
                            }
                            return value.toLocaleString('id-ID');
                        },
                        color: function(context) {
                            return context.dataset.borderColor;
                        },
                        font: {
                            weight: 'bold',
                            size: 8
                        }
                    }
                }
            };
        }
        
        // Chart 1: LAR
        new Chart(document.getElementById('chartDailyLAR').getContext('2d'), {
            type: 'line',
            data: chartLARData,
            options: getDailyChartOptions('LAR', 'LAR')
        });
        
        // Chart 2: NPL
        new Chart(document.getElementById('chartDailyNPL').getContext('2d'), {
            type: 'line',
            data: chartNPLData,
            options: getDailyChartOptions('NPL', 'NPL')
        });
        
        // Chart 3: SML
        new Chart(document.getElementById('chartDailySML').getContext('2d'), {
            type: 'line',
            data: chartSMLData,
            options: getDailyChartOptions('SML', 'SML')
        });
    });
</script>
{% endif %}
{% comment %}
================================================================================
END SECTION: Daily 3 Charts
================================================================================
{% endcomment %}

{% comment %}
================================================================================
SECTION: OS Tables (KONSOL, KANCA ONLY, KCP ONLY)
================================================================================
{% endcomment %}
{% if show_os_tables %}
<style>
    .os-table {
        font-size: 0.75rem;
    }
    .os-table th, .os-table td {
        padding: 0.35rem 0.5rem;
        vertical-align: middle;
        text-align: right;
        white-space: nowrap;
    }
    .os-table th {
        text-align: center;
    }
    .os-table td:nth-child(1),
    .os-table td:nth-child(2),
    .os-table td:nth-child(3),
    .os-table td:nth-child(4),
    .os-table td:nth-child(5) {
        text-align: left;
    }
    /* Header untuk No, Kode Kanca, Kanca */
    .os-table th.header-id {
        background-color: #1e3a5f !important;
        color: white;
    }
    /* Header untuk kolom POSISI (A, B, C, D, E) */
    .os-table .header-posisi {
        background-color: #538dd5 !important;
        color: white;
    }
    .os-table .header-dtd {
        background-color: #808080 !important;
        color: white;
    }
    .os-table .header-mom {
        background-color: #808080 !important;
        color: white;
    }
    .os-table .header-mtd {
        background-color: #808080 !important;
        color: white;
    }
    .os-table .header-ytd {
        background-color: #808080 !important;
        color: white;
    }
    .os-table .header-komitmen {
        background-color: #1e5a3f !important;
        color: white;
    }
    .os-table .header-rkap {
        background-color: #8b4513 !important;
        color: white;
    }
    .os-table .row-total {
        background-color: #1e3a5f !important;
        font-weight: bold;
        color: white !important;
    }
    /* Background selang-seling untuk baris data */
    .os-table tbody tr:not(.row-total):nth-child(odd) {
        background-color: #e8f0f8 !important;
    }
    .os-table tbody tr:not(.row-total):nth-child(even) {
        background-color: #d0e0f0 !important;
    }
    /* Background hijau untuk nilai positif */
    .os-table .bg-positive {
        background-color: #c6efce !important;
        color: #000 !important;
    }
    /* Background merah untuk nilai negatif */
    .os-table .bg-negative {
        background-color: #ffc7ce !important;
        color: #000 !important;
    }
    .os-table .text-positive {
        color: #28a745;
    }
    .os-table .text-negative {
        color: #dc3545;
    }
    .table-title {
        background-color: #0d47a1;
        color: white;
        padding: 0.5rem 1rem;
        font-weight: bold;
        margin-bottom: 0;
    }
    .table-header-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 1rem;
        background-color: #0d47a1;
        color: white;
    }
    .table-header-toolbar .btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    .modal-fullscreen .modal-content {
        height: 100%;
    }
    .modal-fullscreen .modal-body {
        overflow: auto;
    }
    .unit-note {
        font-size: 0.7rem;
        color: #6c757d;
        font-style: italic;
    }
</style>

<!-- Date Filter -->
<div class="card mb-4">
    <div class="card-header bg-white">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <h6 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Filter Tanggal</h6>
            <form method="get" class="d-flex gap-2 align-items-center" id="dateFilterForm">
                <input type="date" class="form-control form-control-sm" name="selected_date" 
                       value="{{ selected_date_str }}" id="selectedDateInput"
                       style="width: 180px;">
                <button type="submit" class="btn btn-primary btn-sm">
                    <i class="fas fa-sync-alt me-1"></i>Terapkan
                </button>
            </form>
        </div>
    </div>
    <div class="card-body py-2">
        <div class="row">
            <div class="col-md-12">
                <small class="text-muted">
                    <strong>Kolom A:</strong> {{ date_columns.A.label }} (Akhir {{ date_columns.A.date|date:"F Y" }}) |
                    <strong>Kolom B:</strong> {{ date_columns.B.label }} (31 Des {{ date_columns.B.date|date:"Y" }}) |
                    <strong>Kolom C:</strong> {{ date_columns.C.label }} (Akhir {{ date_columns.C.date|date:"F Y" }}) |
                    <strong>Kolom D:</strong> {{ date_columns.D.label }} |
                    <strong>Kolom E:</strong> {{ date_columns.E.label }}
                </small>
                <br>
                <span class="unit-note"><i class="fas fa-info-circle me-1"></i>Satuan angka: dalam jutaan Rupiah (Rp. Juta)</span>
            </div>
        </div>
    </div>
</div>

<!-- Table 1: KONSOL -->
<div class="card mb-4" id="konsol-table-card">
    <div class="table-header-toolbar">
        <span><i class="fas fa-table me-2"></i>{{ tables.konsol.title }}</span>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-light btn-sm" onclick="openTableModal('konsol')">
                <i class="fas fa-expand-alt"></i> Perbesar
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="exportTableToExcel('konsol-table', 'KONSOL')">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-hover os-table mb-0" id="konsol-table">
                <thead>
                    <!-- Header Row 1 -->
                    <tr>
                        <th rowspan="3" class="header-id" style="min-width: 40px;">NO</th>
                        <th rowspan="3" class="header-id" style="min-width: 80px;">KODE KANCA</th>
                        <th rowspan="3" class="header-id" style="min-width: 150px;">KANCA</th>
                        <th colspan="5" class="header-posisi">POSISI</th>
                        <th colspan="2" class="header-dtd">DtD</th>
                        <th colspan="2" class="header-mom">MoM</th>
                        <th colspan="2" class="header-mtd">MtD</th>
                        <th colspan="2" class="header-ytd">YtD</th>
                    </tr>
                    <!-- Header Row 2: Date Range -->
                    <tr>
                        <th rowspan="2" class="header-posisi">{{ date_columns.A.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.B.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.C.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.D.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.E.label }}</th>
                        <th colspan="2" class="header-dtd">{{ dtd_header }}</th>
                        <th colspan="2" class="header-mom">{{ mom_header }}</th>
                        <th colspan="2" class="header-mtd">{{ mtd_header }}</th>
                        <th colspan="2" class="header-ytd">{{ ytd_header }}</th>
                    </tr>
                    <!-- Header Row 3: Formula labels -->
                    {% comment %} <tr>
                        <th class="header-dtd">E-D</th>
                        <th class="header-dtd">(E-D)/D%</th>
                        <th class="header-mom">E-B</th>
                        <th class="header-mom">(E-B)/B%</th>
                        <th class="header-mtd">E-C</th>
                        <th class="header-mtd">(E-C)/C%</th>
                        <th class="header-ytd">E-A</th>
                        <th class="header-ytd">(E-A)/A%</th>
                    </tr> {% endcomment %}
                </thead>
                <tbody>
                    {% for row in tables.konsol.rows %}
                    <tr>
                        <td>{{ row.no }}</td>
                        <td>{{ row.kode_kanca }}</td>
                        <td>{{ row.kanca }}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.A|format_integer:0|default:"-" }}{% else %}{{ row.A|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.B|format_integer:0|default:"-" }}{% else %}{{ row.B|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.C|format_integer:0|default:"-" }}{% else %}{{ row.C|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.D|format_integer:0|default:"-" }}{% else %}{{ row.D|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.E|format_integer:0|default:"-" }}{% else %}{{ row.E|format_number:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.DtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.DtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.DtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MoM|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MoM|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MoM_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.YtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.YtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.YtD_pct|floatformat:1 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center text-muted py-3">Tidak ada data untuk tanggal yang dipilih.</td>
                    </tr>
                    {% endfor %}
                    <!-- Total Row -->
                    <tr class="row-total">
                        <td colspan="3" class="text-center" style="background-color: #1e3a5f; color: white;"><strong>RO Bandung</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.A|format_integer:0 }}{% else %}{{ tables.konsol.totals.A|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.B|format_integer:0 }}{% else %}{{ tables.konsol.totals.B|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.C|format_integer:0 }}{% else %}{{ tables.konsol.totals.C|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.D|format_integer:0 }}{% else %}{{ tables.konsol.totals.D|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.E|format_integer:0 }}{% else %}{{ tables.konsol.totals.E|format_number:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.DtD|format_integer_parentheses:0 }}{% else %}{{ tables.konsol.totals.DtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.konsol.totals.DtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.MoM|format_integer_parentheses:0 }}{% else %}{{ tables.konsol.totals.MoM|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.konsol.totals.MoM_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.MtD|format_integer_parentheses:0 }}{% else %}{{ tables.konsol.totals.MtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.konsol.totals.MtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.konsol.totals.YtD|format_integer_parentheses:0 }}{% else %}{{ tables.konsol.totals.YtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.konsol.totals.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.konsol.totals.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.konsol.totals.YtD_pct|floatformat:1 }}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Table 2: KANCA ONLY -->
<div class="card mb-4" id="kanca-table-card">
    <div class="table-header-toolbar" style="background-color: #1b5e20;">
        <span><i class="fas fa-table me-2"></i>{{ tables.kanca.title }}</span>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-light btn-sm" onclick="openTableModal('kanca')">
                <i class="fas fa-expand-alt"></i> Perbesar
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="exportTableToExcel('kanca-table', 'KANCA_ONLY')">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-hover os-table mb-0" id="kanca-table">
                <thead>
                    <!-- Header Row 1 -->
                    <tr>
                        <th rowspan="3" class="header-id" style="min-width: 40px;">NO</th>
                        <th rowspan="3" class="header-id" style="min-width: 80px;">KODE UKER</th>
                        <th rowspan="3" class="header-id" style="min-width: 150px;">UKER</th>
                        <th colspan="5" class="header-posisi">POSISI</th>
                        <th colspan="2" class="header-dtd">DtD</th>
                        <th colspan="2" class="header-mom">MoM</th>
                        <th colspan="2" class="header-mtd">MtD</th>
                        <th colspan="2" class="header-ytd">YtD</th>
                    </tr>
                    <!-- Header Row 2: Date Range -->
                    <tr>
                        <th rowspan="2" class="header-posisi">{{ date_columns.A.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.B.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.C.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.D.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.E.label }}</th>
                        <th colspan="2" class="header-dtd">{{ dtd_header }}</th>
                        <th colspan="2" class="header-mom">{{ mom_header }}</th>
                        <th colspan="2" class="header-mtd">{{ mtd_header }}</th>
                        <th colspan="2" class="header-ytd">{{ ytd_header }}</th>
                    </tr>
                    <!-- Header Row 3: Formula labels -->
                    {% comment %} <tr>
                        <th class="header-dtd">E-D</th>
                        <th class="header-dtd">(E-D)/D%</th>
                        <th class="header-mom">E-B</th>
                        <th class="header-mom">(E-B)/B%</th>
                        <th class="header-mtd">E-C</th>
                        <th class="header-mtd">(E-C)/C%</th>
                        <th class="header-ytd">E-A</th>
                        <th class="header-ytd">(E-A)/A%</th>
                    </tr> {% endcomment %}
                </thead>
                <tbody>
                    {% for row in tables.kanca.rows %}
                    <tr>
                        <td>{{ row.no }}</td>
                        <td>{{ row.kode_uker }}</td>
                        <td>{{ row.uker }}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.A|format_integer:0|default:"-" }}{% else %}{{ row.A|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.B|format_integer:0|default:"-" }}{% else %}{{ row.B|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.C|format_integer:0|default:"-" }}{% else %}{{ row.C|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.D|format_integer:0|default:"-" }}{% else %}{{ row.D|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.E|format_integer:0|default:"-" }}{% else %}{{ row.E|format_number:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.DtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.DtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.DtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MoM|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MoM|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MoM_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.YtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.YtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.YtD_pct|floatformat:1 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center text-muted py-3">Tidak ada data untuk tanggal yang dipilih.</td>
                    </tr>
                    {% endfor %}
                    <!-- Total Row -->
                    <tr class="row-total">
                        <td colspan="3" class="text-center" style="background-color: #1e3a5f; color: white;"><strong>RO Bandung</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.A|format_integer:0 }}{% else %}{{ tables.kanca.totals.A|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.B|format_integer:0 }}{% else %}{{ tables.kanca.totals.B|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.C|format_integer:0 }}{% else %}{{ tables.kanca.totals.C|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.D|format_integer:0 }}{% else %}{{ tables.kanca.totals.D|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.E|format_integer:0 }}{% else %}{{ tables.kanca.totals.E|format_number:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.DtD|format_integer_parentheses:0 }}{% else %}{{ tables.kanca.totals.DtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kanca.totals.DtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.MoM|format_integer_parentheses:0 }}{% else %}{{ tables.kanca.totals.MoM|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kanca.totals.MoM_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.MtD|format_integer_parentheses:0 }}{% else %}{{ tables.kanca.totals.MtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kanca.totals.MtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kanca.totals.YtD|format_integer_parentheses:0 }}{% else %}{{ tables.kanca.totals.YtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kanca.totals.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kanca.totals.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kanca.totals.YtD_pct|floatformat:1 }}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Table 3: KCP ONLY -->
<div class="card mb-4" id="kcp-table-card">
    <div class="table-header-toolbar" style="background-color: #b71c1c;">
        <span><i class="fas fa-table me-2"></i>{{ tables.kcp.title }}</span>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-light btn-sm" onclick="openTableModal('kcp')">
                <i class="fas fa-expand-alt"></i> Perbesar
            </button>
            <button type="button" class="btn btn-success btn-sm" onclick="exportTableToExcel('kcp-table', 'KCP_ONLY')">
                <i class="fas fa-file-excel"></i> Export Excel
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-bordered table-hover os-table mb-0" id="kcp-table">
                <thead>
                    <!-- Header Row 1 -->
                    <tr>
                        <th rowspan="3" class="header-id" style="min-width: 40px;">NO</th>
                        <th rowspan="3" class="header-id" style="min-width: 80px;">KODE UKER</th>
                        <th rowspan="3" class="header-id" style="min-width: 150px;">UKER</th>
                        <th colspan="5" class="header-posisi">POSISI</th>
                        <th colspan="2" class="header-dtd">DtD</th>
                        <th colspan="2" class="header-mom">MoM</th>
                        <th colspan="2" class="header-mtd">MtD</th>
                        <th colspan="2" class="header-ytd">YtD</th>
                    </tr>
                    <!-- Header Row 2: Date Range -->
                    <tr>
                        <th rowspan="2" class="header-posisi">{{ date_columns.A.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.B.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.C.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.D.label }}</th>
                        <th rowspan="2" class="header-posisi">{{ date_columns.E.label }}</th>
                        <th colspan="2" class="header-dtd">{{ dtd_header }}</th>
                        <th colspan="2" class="header-mom">{{ mom_header }}</th>
                        <th colspan="2" class="header-mtd">{{ mtd_header }}</th>
                        <th colspan="2" class="header-ytd">{{ ytd_header }}</th>
                    </tr>
                    {% comment %} <!-- Header Row 3: Formula labels -->
                    <tr>
                        <th class="header-dtd">E-D</th>
                        <th class="header-dtd">(E-D)/D%</th>
                        <th class="header-mom">E-B</th>
                        <th class="header-mom">(E-B)/B%</th>
                        <th class="header-mtd">E-C</th>
                        <th class="header-mtd">(E-C)/C%</th>
                        <th class="header-ytd">E-A</th>
                        <th class="header-ytd">(E-A)/A%</th>
                    </tr> {% endcomment %}
                </thead>
                <tbody>
                    {% for row in tables.kcp.rows %}
                    <tr>
                        <td>{{ row.no }}</td>
                        <td>{{ row.kode_uker }}</td>
                        <td>{{ row.uker }}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.A|format_integer:0|default:"-" }}{% else %}{{ row.A|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.B|format_integer:0|default:"-" }}{% else %}{{ row.B|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.C|format_integer:0|default:"-" }}{% else %}{{ row.C|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.D|format_integer:0|default:"-" }}{% else %}{{ row.D|format_number:0|default:"-" }}{% endif %}</td>
                        <td>{% if metric_type == 'nsb' %}{{ row.E|format_integer:0|default:"-" }}{% else %}{{ row.E|format_number:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.DtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.DtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.DtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MoM|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MoM|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MoM_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.MtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.MtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.MtD_pct|floatformat:1 }}%</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{% if metric_type == 'nsb' %}{{ row.YtD|format_integer_parentheses:0|default:"-" }}{% else %}{{ row.YtD|format_number_parentheses:0|default:"-" }}{% endif %}</td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if row.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if row.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}">{{ row.YtD_pct|floatformat:1 }}%</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="16" class="text-center text-muted py-3">Tidak ada data untuk tanggal yang dipilih.</td>
                    </tr>
                    {% endfor %}
                    <!-- Total Row -->
                    <tr class="row-total">
                        <td colspan="3" class="text-center" style="background-color: #1e3a5f; color: white;"><strong>RO Bandung</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.A|format_integer:0 }}{% else %}{{ tables.kcp.totals.A|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.B|format_integer:0 }}{% else %}{{ tables.kcp.totals.B|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.C|format_integer:0 }}{% else %}{{ tables.kcp.totals.C|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.D|format_integer:0 }}{% else %}{{ tables.kcp.totals.D|format_number:0 }}{% endif %}</strong></td>
                        <td style="background-color: #538dd5; color: white;"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.E|format_integer:0 }}{% else %}{{ tables.kcp.totals.E|format_number:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.DtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.DtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.DtD|format_integer_parentheses:0 }}{% else %}{{ tables.kcp.totals.DtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.DtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.DtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kcp.totals.DtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.MoM >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.MoM >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.MoM|format_integer_parentheses:0 }}{% else %}{{ tables.kcp.totals.MoM|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.MoM_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.MoM_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kcp.totals.MoM_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.MtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.MtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.MtD|format_integer_parentheses:0 }}{% else %}{{ tables.kcp.totals.MtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.MtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.MtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kcp.totals.MtD_pct|floatformat:1 }}%</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.YtD >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.YtD >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{% if metric_type == 'nsb' %}{{ tables.kcp.totals.YtD|format_integer_parentheses:0 }}{% else %}{{ tables.kcp.totals.YtD|format_number_parentheses:0 }}{% endif %}</strong></td>
                        <td class="{% if metric_type in 'dpk,npl,lar,lr' %}{% if tables.kcp.totals.YtD_pct >= 0 %}bg-negative{% else %}bg-positive{% endif %}{% else %}{% if tables.kcp.totals.YtD_pct >= 0 %}bg-positive{% else %}bg-negative{% endif %}{% endif %}"><strong>{{ tables.kcp.totals.YtD_pct|floatformat:1 }}%</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Validation Note -->
<div class="alert alert-info">
    <i class="fas fa-info-circle me-2"></i>
    <strong>Catatan:</strong> 
    <ul class="mb-0">
        <li>Semua nilai dalam tabel ditampilkan dalam satuan <strong>jutaan Rupiah</strong> (contoh: 620,546 = 620,546 juta Rupiah)</li>
        <li>SUM dari KANCA ONLY + SUM dari KCP ONLY = SUM dari KONSOL</li>
        <li>KANCA ONLY ({{ tables.kanca.totals.E|format_number:0 }}) + KCP ONLY ({{ tables.kcp.totals.E|format_number:0 }}) = {{ tables.konsol.totals.E|format_number:0 }} (KONSOL)</li>
    </ul>
</div>

<!-- Table Modal for Full Screen View -->
<div class="modal fade" id="tableModal" tabindex="-1" aria-labelledby="tableModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="tableModalLabel">
                    <i class="fas fa-table me-2"></i><span id="modalTableTitle">Tabel</span>
                </h5>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-success btn-sm" id="modalExportBtn">
                        <i class="fas fa-file-excel"></i> Export Excel
                    </button>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive" style="max-height: calc(100vh - 120px); overflow: auto;">
                    <div id="modalTableContent"></div>
                </div>
            </div>
            <div class="modal-footer">
                <span class="unit-note me-auto"><i class="fas fa-info-circle me-1"></i>Satuan angka: dalam jutaan Rupiah (Rp. Juta)</span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- SheetJS Library for Excel Export -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
// Function to open table in modal
function openTableModal(tableType) {
    let tableId, title, bgColor;
    
    switch(tableType) {
        case 'konsol':
            tableId = 'konsol-table';
            title = '{{ tables.konsol.title }}';
            bgColor = '#0d47a1';
            break;
        case 'kanca':
            tableId = 'kanca-table';
            title = '{{ tables.kanca.title }}';
            bgColor = '#1b5e20';
            break;
        case 'kcp':
            tableId = 'kcp-table';
            title = '{{ tables.kcp.title }}';
            bgColor = '#b71c1c';
            break;
    }
    
    // Get the table HTML
    const table = document.getElementById(tableId);
    const tableClone = table.cloneNode(true);
    tableClone.id = 'modal-' + tableId;
    tableClone.style.fontSize = '0.85rem';
    
    // Update modal
    document.getElementById('modalTableTitle').textContent = title;
    document.getElementById('modalTableContent').innerHTML = '';
    document.getElementById('modalTableContent').appendChild(tableClone);
    document.querySelector('#tableModal .modal-header').style.backgroundColor = bgColor;
    
    // Set up export button
    document.getElementById('modalExportBtn').onclick = function() {
        exportTableToExcel('modal-' + tableId, tableType.toUpperCase());
    };
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('tableModal'));
    modal.show();
}

// Function to export table to Excel
function exportTableToExcel(tableId, filename) {
    const table = document.getElementById(tableId);
    
    if (!table) {
        console.error('Table not found:', tableId);
        return;
    }
    
    // Create workbook from table
    const wb = XLSX.utils.table_to_book(table, {
        sheet: filename,
        raw: true
    });
    
    // Generate filename with date
    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10).replace(/-/g, '');
    const fullFilename = `OS_SMALL_${filename}_${dateStr}.xlsx`;
    
    // Save file
    XLSX.writeFile(wb, fullFilename);
    
    // Show success message
    showToast(`File ${fullFilename} berhasil diunduh!`, 'success');
}

// Toast notification function
function showToast(message, type = 'info') {
    // Create toast container if not exists
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : (type === 'error' ? 'bg-danger' : 'bg-info');
    
    const toastHtml = `
        <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Berhasil' : 'Info'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastElement = document.getElementById(toastId);
    const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
    toast.show();
    
    // Remove after hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        toastElement.remove();
    });
}

// ===============================================
// Date Filter Persistence Handler
// ===============================================
document.addEventListener('DOMContentLoaded', function() {
    const dateFilterForm = document.getElementById('dateFilterForm');
    const dateInput = document.getElementById('selectedDateInput');
    
    if (dateFilterForm && dateInput) {
        // Save date to localStorage when form is submitted
        dateFilterForm.addEventListener('submit', function(e) {
            const selectedDate = dateInput.value;
            if (selectedDate) {
                localStorage.setItem('dashboard_selected_date', selectedDate);
            }
        });
    }
    
    // If date input has no value but localStorage has one, use it
    if (dateInput && !dateInput.value) {
        const storedDate = localStorage.getItem('dashboard_selected_date');
        if (storedDate) {
            dateInput.value = storedDate;
        }
    }
});
</script>
{% endif %}
{% comment %}
================================================================================
END SECTION: OS Tables
================================================================================
{% endcomment %}

{% if tables %}
    {% for table_title in tables %}
        <div class="card mb-4">
            <div class="card-header">{{ table_title }}</div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col">Kolom 1</th>
                                <th scope="col">Kolom 2</th>
                                <th scope="col">Kolom 3</th>
                                <th scope="col">Kolom 4</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    Placeholder tabel. Silakan hubungkan dengan data aktual sesuai judul tabel.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endfor %}
{% else %}
    <div class="alert alert-info">
        Belum ada konfigurasi tabel khusus untuk halaman ini. Gunakan area ini untuk menampilkan ringkasan atau visualisasi sesuai kebutuhan.
    </div>
{% endif %}

{% endif %} {# End of no_data check #}

{% endblock %}
